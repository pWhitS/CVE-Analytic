import sys
import math


def percentChange(v1, v2, growth):
	if int(v1) == 0:
		div1 = 1
	elif int(v1) > 0:
		div1 = v1
	else:
		print "wat.."

	return (((int(v2) - int(v1)) / math.fabs(int(div1))) * 100)


def calculateEffects(vulnsList, vulnType):
	print vulnType
	i = 0
	j = math.floor(len(vulnsList)/2)
	totalChange = 0

	while i < j:
		totalChange += percentChange(vulnsList[i], vulnsList[i+1], 0)
		i += 1

	print totalChange, totalChange/j

	i = int(math.floor(len(vulnsList)/2.0))
	j = len(vulnsList)-1
	totalChange = 0

	while i < j:
		totalChange += percentChange(vulnsList[i], vulnsList[i+1], 0)
		i += 1

	print totalChange, totalChange/j
	print


filename = sys.argv[1]
window = int(sys.argv[2])

with open(filename, 'r') as fin:
	eventList = fin.readlines()

with open("test-month.csv", 'r') as fmonth:
	cveMonthList = fmonth.readlines()


for event in eventList:
	event = event.strip()
	name, date, os = event.split(',')
	month, day, year = date.split('-')

	print name, os, date
	print "=================="

	beforeList = []
	afterList = []
	isAfter = False

	for line in cveMonthList:
		line = line.strip()

		eventDate = str(year) + "-" + str(month)
		cveDate = line.split(',')[0].split(':')[1]

		if eventDate == cveDate:
			isAfter = True

		if isAfter and len(afterList) < window + 1:
			afterList.append(line)
		elif not isAfter:
			if len(beforeList) < window:
				beforeList.append(line)
			else:
				beforeList = beforeList[1:]
				beforeList.append(line)

	#convert lists of strings to lists of dictionaries
	for i in range(len(beforeList)):
		beforeList[i] = dict(item.split(":") for item in beforeList[i].split(","))

	for i in range(len(afterList)):
		afterList[i] = dict(item.split(":") for item in afterList[i].split(","))


	vdict = beforeList[0] #grab dictionary for iteration over keys
	for vulnKey in vdict:
		if vulnKey == "Date":
			continue

		vulnsList = []
		for vulns in beforeList:
			vulnsList.append(vulns[vulnKey])

		for vulns in afterList:
			vulnsList.append(vulns[vulnKey])

		calculateEffects(vulnsList, vulnKey)
