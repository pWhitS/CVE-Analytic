import sys
import math


def percentChange(v1, v2, growth):
	if int(v1) == 0:
		div1 = 1
	elif int(v1) > 0:
		div1 = v1
	else:
		print "wat.."

	return (((int(v2) - int(v1)) / math.fabs(int(div1))) * 100)


def calculateEffects(vBeforeList, vAfterList, vulnType):
	print vulnType
	i = 0
	totalChange = 0

	while i < len(vBeforeList)-1:
		totalChange += percentChange(vBeforeList[i], vBeforeList[i+1], 0)
		i += 1

	print totalChange, totalChange/len(vBeforeList)

	i = 0
	totalChange = 0

	while i < len(vAfterList)-1:
		totalChange += percentChange(vAfterList[i], vAfterList[i+1], 0)
		i += 1

	print totalChange, totalChange/len(vAfterList)
	print 

#---MAIN---#
filename = sys.argv[1]
window = int(sys.argv[2])

with open(filename, 'r') as fin:
	eventList = fin.readlines()

with open("month.csv", 'r') as fmonth:
	cveMonthList = fmonth.readlines()

vtotbd = {}
vtotad = {}

for event in eventList:
	event = event.strip()
	name, date, os = event.split(',')
	month, day, year = date.split('-')

	print name, os, date
	print "=================="

	beforeList = []
	afterList = []
	isAfter = False

	for line in cveMonthList:
		line = line.strip()

		eventDate = str(year) + "-" + str(month)
		cveDate = line.split(',')[0].split(':')[1]

		if eventDate == cveDate:
			isAfter = True

		if isAfter and len(afterList) < window + 1:
			afterList.append(line)
		elif not isAfter:
			if len(beforeList) < window:
				beforeList.append(line)
			else:
				beforeList = beforeList[1:]
				beforeList.append(line)

	#convert lists of strings to lists of dictionaries
	for i in range(len(beforeList)):
		beforeList[i] = dict(item.split(":") for item in beforeList[i].split(","))

	for i in range(len(afterList)):
		afterList[i] = dict(item.split(":") for item in afterList[i].split(","))

	minDate = min([beforeList[i]["Date"] for i in range(len(beforeList))])
	maxDate = max([afterList[i]["Date"] for i in range(len(afterList))])
	print minDate, maxDate

	for vkey in beforeList[0]:
		if vkey == "Date":
			continue

		vulnsBefore = []
		vulnsAfter = []

		#loop over all lists of vulnerabilties in the window
		#generate list for number of vulnerabilties in each type over each month
		for vulns in beforeList:
			vulnsBefore.append(vulns[vkey]) 

		for vulns in afterList:
			vulnsAfter.append(vulns[vkey])

		calculateEffects(vulnsBefore, vulnsAfter, vkey)

	
	beforeTotal = []
	afterTotal = []

	for vulns in beforeList:
		temptot = 0
		for vkey in beforeList[0]:
			if vkey == "Date":
				continue
			temptot += int(vulns[vkey])
		
		beforeTotal.append(temptot)

	for vulns in afterList:
		temptot = 0
		for vkey in afterList[0]:
			if vkey == "Date":
				continue
			temptot += int(vulns[vkey])
		
		afterTotal.append(temptot)

	calculateEffects(beforeTotal, afterTotal, "total")
	


